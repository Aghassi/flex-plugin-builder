<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>flex-plugin-builder documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">flex-plugin-builder documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>Options</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>packages/flex-plugin-scripts/src/scripts/deploy.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#disallowVersioning">disallowVersioning</a>
                                </li>
                                <li>
                                        <a href="#isPluginsPilot">isPluginsPilot</a>
                                </li>
                                <li>
                                        <a href="#isPublic">isPublic</a>
                                </li>
                                <li>
                                        <a href="#overwrite">overwrite</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="disallowVersioning"></a>
                                        <span class="name"><b>disallowVersioning</b><a href="#disallowVersioning"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>disallowVersioning:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="isPluginsPilot"></a>
                                        <span class="name"><b>isPluginsPilot</b><a href="#isPluginsPilot"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>isPluginsPilot:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="isPublic"></a>
                                        <span class="name"><b>isPublic</b><a href="#isPublic"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>isPublic:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="overwrite"></a>
                                        <span class="name"><b>overwrite</b><a href="#overwrite"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>overwrite:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { logger, semver, progress, FlexPluginError, UserActionError } from &#x27;flex-dev-utils&#x27;;
import { ReleaseType } from &#x27;flex-dev-utils/dist/semver&#x27;;
import { confirm } from &#x27;flex-dev-utils/dist/inquirer&#x27;;
import { checkFilesExist, updateAppVersion, getPackageVersion, getPaths } from &#x27;flex-dev-utils/dist/fs&#x27;;
import { AuthConfig, getCredential } from &#x27;flex-dev-utils/dist/credentials&#x27;;
import { singleLineString } from &#x27;flex-dev-utils/dist/strings&#x27;;
import AccountsClient from &#x27;../clients/accounts&#x27;;
import { setEnvironment } from &#x27;../index&#x27;;
import { deploySuccessful, pluginsApiWarning } from &#x27;../prints&#x27;;
import { UIDependencies } from &#x27;../clients/configuration-types&#x27;;

import run from &#x27;../utils/run&#x27;;
import { Build, Runtime, Version } from &#x27;../clients/serverless-types&#x27;;
import { AssetClient, BuildClient, DeploymentClient, ConfigurationClient, PluginsApiClient } from &#x27;../clients&#x27;;
import getRuntime from &#x27;../utils/runtime&#x27;;

const allowedBumps &#x3D; [
  &#x27;major&#x27;,
  &#x27;minor&#x27;,
  &#x27;patch&#x27;,
  &#x27;version&#x27;,
];

interface Options {
  isPublic: boolean;
  overwrite: boolean;
  disallowVersioning: boolean;
  isPluginsPilot: boolean;
}

export interface DeployResult {
  serviceSid: string;
  accountSid: string;
  environmentSid: string;
  domainName: string;
  isPublic: boolean;
  nextVersion: string;
  pluginUrl: string;
}

/**
 * Verifies the new plugin path does not have collision with existing paths of the deployed Runtime service.
 *
 * @param baseUrl   the baseURL of the file
 * @param build     the existing build
 */
export const _verifyPath &#x3D; (baseUrl: string, build: Build) &#x3D;&gt; {
  const bundlePath &#x3D; &#x60;${baseUrl}/bundle.js&#x60;;
  const sourceMapPath &#x3D; &#x60;${baseUrl}/bundle.js.map&#x60;;

  const existingAssets &#x3D; build.asset_versions;
  const existingFunctions &#x3D; build.function_versions;

  const checkPathIsUnused &#x3D; (v: Version) &#x3D;&gt; v.path !&#x3D;&#x3D; bundlePath &amp;&amp; v.path !&#x3D;&#x3D; sourceMapPath;

  return existingAssets.every(checkPathIsUnused) &amp;&amp; existingFunctions.every(checkPathIsUnused);
};

/**
 * Validates Flex UI version requirement
 * @param flexUI        the flex ui version
 * @param dependencies  the package.json dependencie
 * @param allowReact    whether this deploy supports unbundled React
 * @private
 */
export const _verifyFlexUIConfiguration &#x3D; async (flexUI: string, dependencies: UIDependencies, allowReact: boolean) &#x3D;&gt; {
  const coerced &#x3D; semver.coerce(flexUI);
  if (!allowReact) {
    return;
  }
  const UISupports &#x3D; semver.satisfies(&#x27;1.19.0&#x27;, flexUI) || (coerced &amp;&amp; semver.satisfies(coerced, &#x27;&gt;&#x3D;1.19.0&#x27;));
  if (!UISupports) {
    throw new FlexPluginError(singleLineString(
      &#x60;We detected that your account is using Flex UI version ${flexUI} which is incompatible&#x60;,
      &#x60;with unbundled React. Please visit https://flex.twilio.com/admin/versioning and update to&#x60;,
      &#x60;version 1.19 or above.&#x60;,
    ));
  }

  if (!dependencies.react || !dependencies[&#x27;react-dom&#x27;]) {
    throw new FlexPluginError(&#x27;To use unbundled React, you need to set the React version from the Developer page&#x27;);
  }

  const reactSupported &#x3D; semver.satisfies(getPackageVersion(&#x27;react&#x27;), &#x60;${dependencies.react}&#x60;);
  const reactDOMSupported &#x3D; semver.satisfies(getPackageVersion(&#x27;react-dom&#x27;), &#x60;${dependencies[&#x27;react-dom&#x27;]}&#x60;);
  if (!reactSupported || !reactDOMSupported) {
    logger.newline();
    logger.warning(singleLineString(
      &#x60;The React version ${getPackageVersion(&#x27;react&#x27;)} installed locally&#x60;,
      &#x60;is incompatible with the React version ${dependencies.react} installed on your Flex project.&#x60;,
    ));
    logger.info(singleLineString(
      &#x27;Change your local React version or visit https://flex.twilio.com/admin/developers to&#x27;,
      &#x60;change the React version installed on your Flex project.&#x60;,
    ));
    const answer &#x3D; await confirm(&#x27;Do you still want to continue deploying?&#x27;, &#x27;N&#x27;);
    if (!answer) {
      logger.newline();
      throw new UserActionError(&#x27;User rejected confirmation to deploy with mismatched React version.&#x27;);
    }
  }
};

/**
 * Returns the Account object only if credentials provided is AccountSid/AuthToken, otherwise returns a dummy data
 * @param runtime     the {@link Runtime}
 * @param credentials the {@link AuthConfig}
 * @private
 */
export const _getAccount &#x3D; async (runtime: Runtime, credentials: AuthConfig) &#x3D;&gt; {
  const accountClient &#x3D; new AccountsClient(credentials);

  if (credentials.username.startsWith(&#x27;AC&#x27;)) {
    return accountClient.get(runtime.service.account_sid)
  }

  return {
    sid: runtime.service.account_sid,
  }
}

/**
 * The main deploy script. This script performs the following in order:
 * 1. Verifies bundle file exists, if not warns about running &#x60;npm run build&#x60; first
 * 2. Fetches the default Service and Environment from Serverless API
 * 3. Fetches existing Build
 * 4. Verifies the new bundle path does not collide with files in existing Build
 * 5. Creates a new Asset (and an AssetVersion), and uploads the file to S3 for both the bundle and source map
 * 6. Appends the new two files to existing Build&#x27;s files and creates a new Build
 * 7. Creates a new deployment and sets the Environment build to the new Build.
 *
 * @param nextVersion   the next version of the bundle
 * @param options       options for this deploy
 */
export const _doDeploy &#x3D; async (nextVersion: string, options: Options): Promise&lt;DeployResult&gt; &#x3D;&gt; {
  if (!checkFilesExist(getPaths().app.bundlePath)) {
    throw new FlexPluginError(&#x27;Could not find build file. Did you run &#x60;twilio flex:plugins:build&#x60; first?&#x27;);
  }

  const pluginBaseUrl &#x3D; getPaths().assetBaseUrlTemplate.replace(&#x27;%PLUGIN_VERSION%&#x27;, nextVersion);
  const bundleUri &#x3D; &#x60;${pluginBaseUrl}/bundle.js&#x60;;
  const sourceMapUri &#x3D; &#x60;${pluginBaseUrl}/bundle.js.map&#x60;;

  const credentials &#x3D; await getCredential();
  if (options.isPluginsPilot) {
    const pluginsApiClient &#x3D; new PluginsApiClient(credentials);
    const hasFlag &#x3D; await pluginsApiClient.hasFlag();
    if (!hasFlag) {
      throw new FlexPluginError(&#x27;This command is currently in Preview and is restricted to users while we work on improving it. If you would like to participate, please contact flex@twilio.com to learn more.&#x27;);
    }

    pluginsApiWarning();
  }

  logger.info(&#x27;Uploading your Flex plugin to Twilio Assets\n&#x27;);

  const runtime &#x3D; await getRuntime(credentials);
  if (!runtime.environment) {
    throw new FlexPluginError(&#x27;No Runtime environment was found&#x27;);
  }
  const pluginUrl &#x3D; &#x60;https://${runtime.environment.domain_name}${bundleUri}&#x60;;

  const configurationClient &#x3D; new ConfigurationClient(credentials);
  const buildClient &#x3D; new BuildClient(credentials, runtime.service.sid);
  const assetClient &#x3D; new AssetClient(credentials, runtime.service.sid);
  const deploymentClient &#x3D; new DeploymentClient(credentials, runtime.service.sid, runtime.environment.sid);

  // Validate Flex UI version
  const allowReact &#x3D; process.env.UNBUNDLED_REACT &#x3D;&#x3D;&#x3D; &#x27;true&#x27;;
  const uiVersion &#x3D; await configurationClient.getFlexUIVersion();
  const uiDependencies &#x3D; await configurationClient.getUIDependencies();
  await _verifyFlexUIConfiguration(uiVersion, uiDependencies, allowReact);

  // Check duplicate routes
  const routeCollision &#x3D; await progress(&#x27;Validating the new plugin bundle&#x27;, async () &#x3D;&gt; {
    const collision &#x3D; runtime.build ? !_verifyPath(pluginBaseUrl, runtime.build) : false;

    if (collision) {
      if (options.overwrite) {
        if (!options.disallowVersioning) {
          logger.newline();
          logger.warning(&#x27;Plugin already exists and the flag --overwrite is going to overwrite this plugin.&#x27;);
        }
      } else {
        throw new FlexPluginError(&#x60;You already have a plugin with the same version: ${pluginUrl}&#x60;);
      }
    }

    return collision;
  });

  const buildAssets &#x3D; runtime.build ? runtime.build.asset_versions : [];
  const buildFunctions &#x3D; runtime.build ? runtime.build.function_versions : [];
  const buildDependencies &#x3D; runtime.build ? runtime.build.dependencies : [];

  // Upload plugin bundle and source map to S3
  const buildData &#x3D; await progress(&#x27;Uploading your plugin bundle&#x27;, async () &#x3D;&gt; {
    // Upload bundle and sourcemap
    const bundleVersion &#x3D; await assetClient
      .upload(getPaths().app.name, bundleUri, getPaths().app.bundlePath, !options.isPublic);
    const sourceMapVersion &#x3D; await assetClient
      .upload(getPaths().app.name, sourceMapUri, getPaths().app.sourceMapPath, !options.isPublic);

    const existingAssets &#x3D; routeCollision &amp;&amp; options.overwrite
      ?  buildAssets.filter((v) &#x3D;&gt; v.path !&#x3D;&#x3D; bundleUri &amp;&amp; v.path !&#x3D;&#x3D; sourceMapUri)
      :  buildAssets;

    // Create build
    const data &#x3D; {
      FunctionVersions: buildFunctions.map((v) &#x3D;&gt; v.sid),
      AssetVersions: existingAssets.map((v) &#x3D;&gt; v.sid),
      Dependencies: buildDependencies,
    };
    data.AssetVersions.push(bundleVersion.sid);
    data.AssetVersions.push(sourceMapVersion.sid);

    return data;
  });

  // Register service sid with Config service
  await progress(&#x27;Registering plugin with Flex&#x27;, async () &#x3D;&gt; {
    await configurationClient.registerSid(runtime.service.sid);
  });

  // Create a build, and poll regularly until build is complete
  await progress(&#x27;Deploying a new build of your Twilio Runtime&#x27;, async () &#x3D;&gt; {
    const newBuild &#x3D; await buildClient.create(buildData);
    const deployment &#x3D; await deploymentClient.create(newBuild.sid);

    updateAppVersion(nextVersion);

    return deployment;
  });

  deploySuccessful(pluginUrl, options.isPublic, await _getAccount(runtime, credentials));

  return {
    serviceSid: runtime.service.sid,
    accountSid: runtime.service.account_sid,
    environmentSid: runtime.environment.sid,
    domainName: runtime.environment.domain_name,
    isPublic: options.isPublic,
    nextVersion,
    pluginUrl,
  };
};

const deploy &#x3D; async (...argv: string[]) &#x3D;&gt; {
  setEnvironment(...argv);
  logger.debug(&#x27;Deploying Flex plugin&#x27;);

  const disallowVersioning &#x3D; argv.includes(&#x27;--disallow-versioning&#x27;);
  let nextVersion &#x3D; argv[1] as string;
  const bump &#x3D; argv[0];
  const opts: Options &#x3D; {
    isPublic: argv.includes(&#x27;--public&#x27;),
    overwrite: argv.includes(&#x27;--overwrite&#x27;) || disallowVersioning,
    isPluginsPilot: argv.includes(&#x27;--pilot-plugins-api&#x27;),
    disallowVersioning,
  };

  if (!disallowVersioning) {
    if (!allowedBumps.includes(bump)) {
      throw new FlexPluginError(&#x60;Version bump can only be one of ${allowedBumps.join(&#x27;, &#x27;)}&#x60;);
    }

    if (bump &#x3D;&#x3D;&#x3D; &#x27;version&#x27; &amp;&amp; !argv[1]) {
      throw new FlexPluginError(&#x27;Custom version bump requires the version value.&#x27;);
    }

    if (bump &#x3D;&#x3D;&#x3D; &#x27;overwrite&#x27;) {
      opts.overwrite &#x3D; true;
      nextVersion &#x3D; getPaths().app.version;
    } else if (bump !&#x3D;&#x3D; &#x27;version&#x27;) {
      nextVersion &#x3D; semver.inc(getPaths().app.version, bump as ReleaseType) as any;
    }
  } else {
    nextVersion &#x3D; &#x27;0.0.0&#x27;;
  }

  return await _doDeploy(nextVersion, opts);
};

run(deploy);

export default deploy;
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'Options.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
